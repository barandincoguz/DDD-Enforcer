name: Backend CI

on:
  push:
    branches: ["main", "feature/**"]
    paths:
      - "backend/**"
  pull_request:
    branches: ["main"]
    paths:
      - "backend/**"

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./backend

    steps:
      # 1. YENİ ADIM: Gereksiz dosyaları silip yer açıyoruz (~10GB yer açar)
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space-action@v1.3.1
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: false

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      # 2. GÜNCELLEME: Önce CPU versiyonu Torch yükle, sonra diğerlerini
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip

          # ÖNEMLİ: PyTorch'un CPU versiyonunu (küçük boyutlu) zorla yüklüyoruz.
          # Bu sayede requirements.txt içindeki devasa GPU versiyonunu indirmez.
          pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu

          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest httpx

      - name: Check Syntax (Compile Check)
        run: |
          python -m compileall .

      - name: Run Basic Tests
        run: |
          pytest || echo "No tests found yet, skipping..."
